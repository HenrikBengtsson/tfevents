: ${R_HOME=`R RHOME`}
if test -z "${R_HOME}"; then
  echo "could not determine R_HOME"
  exit 1
fi
CC=`"${R_HOME}/bin/R" CMD config CC`
CFLAGS=`"${R_HOME}/bin/R" CMD config CFLAGS`
CPPFLAGS=`"${R_HOME}/bin/R" CMD config CPPFLAGS`
LDFLAGS=`"${R_HOME}/bin/R" CMD config LDFLAGS`

cd src

if [ ! -d "libs" ]; then
  mkdir build && cd build
  cmake ../../inst/tp/pb \
    -DCMAKE_BUILD_TYPE=Release \
    -DBUILD_SHARED_LIBS:bool=OFF \
    -DCMAKE_POSITION_INDEPENDENT_CODE:bool=ON \
    -Dprotobuf_BUILD_TESTS=OFF
  ${MAKE} -j8
  cd ..
  mkdir libs
  cp build/libprotobuf.a libs/
  cp build/protoc libs/
  rm -r build
else
  echo "Protobuf is already built."
fi

if [ ! -d "generated" ]; then
  mkdir generated

  ./libs/protoc -I "proto" --cpp_out="generated" "proto/event.proto"
  ./libs/protoc -I "proto" --cpp_out="generated" "proto/summary.proto"
  ./libs/protoc -I "proto" --cpp_out="generated" "proto/tensor.proto"
  ./libs/protoc -I "proto" --cpp_out="generated" "proto/resource_handle.proto"
  ./libs/protoc -I "proto" --cpp_out="generated" "proto/tensor_shape.proto"
  ./libs/protoc -I "proto" --cpp_out="generated" "proto/types.proto"
  ./libs/protoc -I "proto" --cpp_out="generated" "proto/plugins/scalar/plugin_data.proto"
fi

# copied from protolite:
# Suppress wanrings about pragmas in the autogenerated protobuf headers.
# Uwe + BDR have said this is OK and there is nothing we can do about this.
find ./ -type f -name "*.pb.h" -exec sed -i.bak "s@  #pragma@/*nowarn*/#pragma@g" {} \;
